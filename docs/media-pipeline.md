# Media Pipeline Overview

This document summarizes the end-to-end flow for inbound WhatsApp media and how
files are hydrated for the chat UI.

## High-Level Flow

1. **Webhook intake**
   - `/webhook/meta` verifies the Meta signature, normalizes the payload, and
     drops duplicates via `providerMessageId`.
   - A pending `messages.media` record is written with origin metadata but no
     file paths yet. WebSocket clients receive an immediate bubble with a
     loading skeleton.

2. **Ingestion queue**
   - `ingestWhatsappMedia` fetches media metadata from Graph, retries on
     transient failures, enforces configured size limits, and downloads the
     binary with the bot access token.
   - Files are saved under `uploads/incoming/original` with sanitized names.

3. **Thumbnailing**
   - Images (JPG/PNG/WEBP/HEIC) and PDFs are passed through `sharp` for
     orientation fixes and thumbnail generation (`uploads/incoming/thumbnails`).
   - Unsupported previews fall back to file-type icons on the client.

4. **Persistence & cache**
   - `messages.media.storage` stores the relative file locations; the DB never
     holds signed URLs. Metadata (mime, size, checksum, width/height, etc.) is
     updated atomically.
   - On success the message is rebroadcast via WebSocket as
     `message_media_updated`.

5. **Delivery**
   - Files are served through `GET /media/*`, which requires a valid signature
     generated by `buildSignedMediaPath` (default TTL 15 minutes). Signed links
     are reissued on every API response to avoid stale URLs.
   - The React client lazy-loads thumbnails, shows accessible placeholders
     while processing, and opens originals in a new tab.

## Outbound Uploads

- Operator uploads are stored under `uploads/outbound/original` via Multer.
- The upload API returns a signed `/media/...` URL; sending a message re-signs
  it server-side before handing it to WhatsApp.
- Outbound message rows mirror the same `messages.media` structure so the UI
  renders consistently.

## Security Notes

- `FILES_SIGNING_SECRET` is required. If rotated, restart the server so the new
  secret signs and validates URLs.
- Raw Graph URLs are never exposed; only server-hosted, signed links are sent
  to the UI or Meta.
